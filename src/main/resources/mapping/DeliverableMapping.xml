<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.authine.cloudpivot.ext.mapper.DeliverableMapper">
    <resultMap id="DeliverableMap" type="com.authine.cloudpivot.ext.vo.DeliverableVO">
        <id column="id" property="id" jdbcType="VARCHAR"/>
        <result column="JobCode" property="jobCode" jdbcType="VARCHAR"/>
        <result column="ProjectName" property="projectName" jdbcType="VARCHAR"/>
        <result column="DeliverableDescription" property="deliverableDescription" jdbcType="VARCHAR"/>
        <result column="DeliverableCategory" property="deliverableCategory" jdbcType="VARCHAR"/>
        <result column="ClientPrice" property="clientPrice" jdbcType="DECIMAL"/>
        <result column="unitCost" property="unitCost" jdbcType="DECIMAL"/>
        <result column="Quantity" property="quantity" jdbcType="DECIMAL"/>
        <result column="Profit" property="profit" jdbcType="DECIMAL"/>

        <result column="Margin" property="margin" jdbcType="DECIMAL"/>
        <result column="VenforTax" property="venforTax" jdbcType="DECIMAL"/>
        <result column="ClientTax" property="clientTax" jdbcType="DECIMAL"/>
        <result column="ClientUnitPrice" property="clientUnitPrice" jdbcType="DECIMAL"/>

    </resultMap>
    <select id="getDeliverableList" resultType="com.authine.cloudpivot.ext.vo.DeliverableVO">
        SELECT ROUND(SUM(ClientPrice),2) as sumClientPrice,ROUND(SUM(UnitCost),2) as sumUnitCost from i_deliverable
    </select>
    <select id="queryDeliverables" resultMap="DeliverableMap" parameterType="com.authine.cloudpivot.ext.queryVo.QueryDeliverable">
              select
              id,
              JobCode,
              DeliverableDescription,
              DeliverableCategory,
              ClientPrice,
              unitCost,
              Quantity,
              Profit,
              Margin,
              VenforTax,
              ClientTax
              from
              i_deliverable t
              where 1=1
              <if test="Jobcode != null and Jobcode != '' ">
                    AND  t.JobCode =#{Jobcode}
              </if>
    </select>


    <insert id="addContractRelation" parameterType="java.util.List">
        INSERT INTO i_deliverable_contract(id,deliverableId,contractId,type)
        VALUES
        <foreach collection="list" item="deliverableContract" separator=",">
            (#{deliverableContract.id},#{deliverableContract.deliverableId},#{deliverableContract.contractId},#{deliverableContract.type})
        </foreach>
    </insert>
    <update id="updateRelationInfo" parameterType="com.authine.cloudpivot.ext.queryVo.DeliverableContractParam">
        update i_deliverable
        <set>
            <if test="type=='clientContract'">  clientContractContent=#{clientContractContent}</if>
            <if test="type=='vendorContract'"> vendorContractContent=#{vendorContractContent}</if>
            <if test="type=='clientPayment'">  clientPaymentContent=#{clientPaymentFinContent}</if>
            <if test="type=='vendorPayment'">  vendorPaymentContent=#{stagePaymentContent}</if>
        </set>
        where id=#{deliverableId}
    </update>

    <insert id="addClientContractInfo" parameterType="java.util.List">
        INSERT INTO i_clientcontractinfo(
                            id,ClientContractStatus,ContractType,ClientName,
                            ClientContractVersion,ClientContractCode,ClientContractStartDate,
                            ClientContractEndDate,ContractValue,parentId
        )
        VALUES
        <foreach collection="list" item="clientContractInfo" separator=",">
            (
                #{clientContractInfo.id},#{clientContractInfo.clientContractStatus},#{clientContractInfo.contractType},
                #{clientContractInfo.clientName},#{clientContractInfo.clientContractVersion},#{clientContractInfo.clientContractCode},
                #{clientContractInfo.clientContractStarttime},#{clientContractInfo.clientContractEndtime},#{clientContractInfo.contractValue},#{clientContractInfo.parentId}
            )
        </foreach>
    </insert>

    <insert id="addVendorContractInfo" parameterType="java.util.List">
        INSERT INTO
        i_vendorcontractinfo(
            id,VendorContractStatus,ContractType,VendorName,
            VendorContractVersion,VendorContractCode,VendorContractStartDate,
            VendorContractEndDate,VenderContracgtSigningDate,ContractValue,parentId
        )
        VALUES
        <foreach collection="list" item="vendorContractInfo" separator=",">
            (
            #{vendorContractInfo.id},#{vendorContractInfo.vendorContractStatus},#{vendorContractInfo.contractType},
            #{vendorContractInfo.vendorName},#{vendorContractInfo.vendorContractVersion},#{vendorContractInfo.vendorContractCode},
            #{vendorContractInfo.vendorContractStarttime},#{vendorContractInfo.vendorContractEndtime},#{vendorContractInfo.venderContracgtSigningDate}
            ,#{vendorContractInfo.contractValue},#{vendorContractInfo.parentId}
            )
        </foreach>
    </insert>

    <insert id="addClientPaymentInfo" parameterType="java.util.List">
        INSERT INTO
        i_clientpaymentinfo(
            id,ClientPO,ClientPOValue,InvoicingDateToClient,ClientInvoice,
            ClientInvoiceTotalAmountBF,ClientInvoiceTotalAmountAF,ClientPaymentCheckDate,
            ClientPaymentAging,ClientPaymentRemittanceDate,ClientPaymentOverDue,parentId
        )
        VALUES
        <foreach collection="list" item="clientPaymentInfo" separator=",">
            (
                #{clientPaymentInfo.id},#{clientPaymentInfo.clientPO},#{clientPaymentInfo.clientPOvalue},
                #{clientPaymentInfo.invoicingDateClient},#{clientPaymentInfo.clientInvoice},
                #{clientPaymentInfo.clientInvoiceTotalAmountBF},#{clientPaymentInfo.clientInvoiceTotalAmountAF},
                #{clientPaymentInfo.clientPaymentCheckDate},#{clientPaymentInfo.clientPaymentAging},
                #{clientPaymentInfo.clientPaymentRemittanceDate},#{clientPaymentInfo.clientPaymentOverDue},#{clientPaymentInfo.parentId}
            )
        </foreach>
    </insert>

    <insert id="addVendorPaymentInfo" parameterType="java.util.List">
        INSERT INTO
        i_vendorpaymentinfo(
            id,vendorInvoicingDate,Installment,PaymentDateSelectionToVendor,paramIndex,PaymentCheckDateToVendor,
            ActualPaymentDateToVendor,OfInstallment,VendorInvoice,parentId
        )
        VALUES
        <foreach collection="list" item="vendorPaymentInfo" separator=",">
            (
            #{vendorPaymentInfo.id},
            #{vendorPaymentInfo.vendorInvoicingDate},
            #{vendorPaymentInfo.installment},
            #{vendorPaymentInfo.paymentVendorDate},
            #{vendorPaymentInfo.index},
            #{vendorPaymentInfo.paymentCheckDate},
            #{vendorPaymentInfo.actualPaymentDate},
            #{vendorPaymentInfo.pay},
            #{vendorPaymentInfo.vendorInvoice},
            #{vendorPaymentInfo.parentId}
            )
        </foreach>
    </insert>

    <update id="updateDeliverableStatus">
        update i_deliverable set where  id=#{id}

    </update>
</mapper>