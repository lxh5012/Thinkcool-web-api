<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.authine.cloudpivot.ext.mapper.SummaryTaskMapper">

    <!-- <resultMap id="BaseResultMap" type="com.authine.cloudpivot.web.api.entity.SummaryTaskModel">
       <result column="id" jdbcType="INTEGER" property="id" />
        <result column="userName" jdbcType="VARCHAR" property="userName" />
        <result column="passWord" jdbcType="VARCHAR" property="passWord" />
        <result column="realName" jdbcType="VARCHAR" property="realName" />
    </resultMap>-->


    <select id="queryProjectTask"  parameterType="com.authine.cloudpivot.ext.vo.SummaryTaskModel" resultType="com.authine.cloudpivot.ext.vo.SummaryTaskModel">
        SELECT
        t.id AS summaryId,
        (SELECT b.`name` from i_ProjectTeamBU b where b.id = t.bu ) as bu,
        t.ContractLegalEntity AS contractLegalEntity,
        t.ClientGroup AS clientGroup,
        t.ClientBrand AS clientBrand,
        t.Jobcode AS jobCode,
        t.ProjectName AS projectName,
        date_format(t.ProjectStartDate,'%Y/%m/%d') AS projectStartDate,
        date_format(t.ProjectEndDate,'%Y/%m/%d') AS projectEndDate,
        count(t.jobCode) AS deliverableNum,
        (SELECT COUNT(1) FROM  i_dispatchsheet dis  WHERE  dis.Jobcode = t.jobCode ) AS taskNum,
        (SELECT	COUNT(1) FROM i_dispatchsheet dis WHERE dis.sequenceStatus = 'COMPLETED' AND dis.Jobcode = t.jobCode) AS finishedNum
        FROM	i_deliverable t
        where   (t.owner = #{userId, jdbcType=VARCHAR} or t.creater = #{userId, jdbcType=VARCHAR})
        <if test="bu != null ">
            AND  t.bu = #{bu, jdbcType=VARCHAR}
        </if>
        <if test="contractLegalEntity != null ">
            AND  t.ContractLegalEntity = #{contractLegalEntity, jdbcType=VARCHAR}
        </if>
        <if test="clientGroup != null ">
            AND  t.ClientGroup = #{clientGroup, jdbcType=VARCHAR}
        </if>
        <if test="clientBrand != null ">
            AND  t.ClientBrand = #{clientBrand, jdbcType=VARCHAR}
        </if>
        <if test="jobCode != null ">
            AND  t.Jobcode = #{jobCode, jdbcType=VARCHAR}
        </if>
        <if test="projectName != null ">
            AND  t.ProjectName = #{projectName, jdbcType=VARCHAR}
        </if>
        <if test="projectStartDate != null">
            AND  t.ProjectStartDate <![CDATA[>=]]>  #{projectName, jdbcType=DATE}
        </if>
        <if test="projectEndDate != null">
            AND  t.ProjectEndDate <![CDATA[>=]]>  #{projectEndDate, jdbcType=DATE}
        </if>
        GROUP BY jobCode order by t.ProjectStartDate desc
    </select>

    <select id="queryDeliverableTask"  parameterType="com.authine.cloudpivot.ext.vo.DeliverableTaskVO" resultType="com.authine.cloudpivot.ext.vo.DeliverableTaskVO">
        SELECT
            t.Jobcode AS jobCode,
            t.ProjectName AS projectName,
            (SELECT c.`name` from i_category c where c.id= t.DeliverableCategory ) AS deliverableCategory,
            t.DeliverableDescription AS deliverableDescription,
            (SELECT count(1) FROM i_DispatchSheet d WHERE d.Jobcode = t.Jobcode
                AND d.DeliverableCategory = t.DeliverableCategory ) AS taskNumber,
            ( SELECT count(1) FROM i_DispatchSheet d WHERE d.sequenceStatus = 'PROCESSING' and d.Jobcode = t.Jobcode AND d.DeliverableCategory = t.DeliverableCategory ) AS unfinishNumber,
            ( SELECT count(1) FROM i_DispatchSheet d WHERE d.sequenceStatus = 'COMPLETED' and d.Jobcode = t.Jobcode AND d.DeliverableCategory = t.DeliverableCategory ) AS finishNumber,
            ( SELECT date_format(max(d.Deadline), '%Y/%m/%d') FROM i_DispatchSheet d WHERE d.Jobcode = t.Jobcode AND d.DeliverableCategory = t.DeliverableCategory ) AS deadline
        FROM	i_deliverable t
        where  (t.owner = #{userId, jdbcType=VARCHAR} or t.creater = #{userId, jdbcType=VARCHAR})
          and t.Jobcode= #{jobCode, jdbcType=VARCHAR}
        GROUP BY t.DeliverableCategory order by t.createdTime desc
    </select>
</mapper>